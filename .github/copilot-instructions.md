# SchoolSoft Codebase Guide

## Architecture Overview

SchoolSoft is a multi-tenant PHP school management system with a hybrid legacy/modern architecture. Each school runs as a subdirectory (e.g., `/demo`, `/omar`) with its own configuration, database connection, and user sessions.

**Key architectural patterns:**
- **Multi-tenant structure**: Each school folder in root contains complete app instance with `app.php` bootstrap, `database.php`, and school-specific configs
- **Dual ORM approach**: Legacy `Classes\DataBase\DB` (raw queries) coexists with modern Eloquent models in `app/Models/`
- **Two database connections**: `central` (shared schools table) and `tenant` (per-school data). Set via `Core\Database` in bootstrap
- **Path constants**: Every school defines `__ROOT_SCHOOL`, `__SCHOOL_URL`, `__SCHOOL_ACRONYM` in `demo/app.php` for multi-tenant routing

## Critical Bootstrap Flow

1. **Entry point**: Each PHP file in school folder (e.g., `demo/admin/home.php`) starts with `require_once '../app.php'`
2. **`demo/app.php`**: Defines school-specific constants, loads central bootstrap, initializes Database, sets locale
3. **Root `bootstrap.php`**: Composer autoload, .env loading, Eloquent setup, morph map
4. **`demo/constants.php`**: Dynamically loads school config from `central` connection using `__SCHOOL_ACRONYM`

**Never skip the `app.php` require** - it establishes tenant context and database connections.

## Translation System (Dual Implementation)

**Modern approach** (preferred for new code):
```php
// Uses Laravel translator with JSON files in lang/en.json, lang/es/
__('Welcome back')  // Returns translated string based on locale
trans_choice('student.count', 5)  // Pluralization
```

**Legacy `Classes\Lang`** (still widely used):
```php
$lang = new Lang([
    ['Inicio', 'Home'],
    ['Estudiante', 'Student']
]);
echo $lang->translation('Inicio');  // Returns 'Home' if __LANG === 'en'
```
Any time translations are added, prefer the modern `__()` function.

The `__LANG` constant (set in `demo/app.php`) drives both systems. Per-admin language overrides exist for admin panel users.

## Eloquent Models & PHPDoc Generation

Models live in `app/Models/` with comprehensive PHPDoc generated by `demo/phpdocs.php`:
```bash
php demo/phpdocs.php Student  # Generate PHPDoc for Student model
php demo/phpdocs.php          # Regenerate all models
```

**Critical model patterns:**
- Many models use legacy table names (e.g., `Student` → `year` table, `Family` → `madre`)
- Global scopes are common: `Student` auto-filters by current year and excludes unenrolled
- Relationships include morph map for `student`/`admin` polymorphic types
- Properties are auto-documented including Eloquent relationships and casts

## Helper Functions & Utilities

**School-specific config/assets** (respects multi-tenancy):
```php
school_config('app.acronym')        // Reads from /demo/config/app.php
school_asset('css/main.css')        // Returns URL: /demo/css/main.css
school_logo()                       // Current school's logo URL
```

**Global config/assets**:
```php
config('app.locale')                // Reads from root /config/app.php
asset('images/globe.gif')           // Returns URL without school prefix
```

**File uploads**:
```php
upload_attachment($_FILES['docs'], 'messages')  // Auto-creates attachments/messages/
attachments_url('letters/doc.pdf')              // Returns full URL
```

## Session & Authentication

Authentication is location-based (admin, regiweb, foro, parents, cafeteria). `Classes\Login::login()` creates sessions with:
```php
$_SESSION['logged'] = [
    'acronym' => __SCHOOL_ACRONYM,  // Prevents cross-school access
    'location' => 'admin',
    'user' => ['id' => $userId]
];
```

**Always use** `Session::is_logged()` at top of protected pages. It validates acronym, location, and 4-hour timeout.

## Routing & Views

No formal router - direct file execution with `Route` helper for includes:
```php
Route::includeFile('/admin/includes/layouts/header.php');  // Loads from school folder
Route::includeFile('/includes/react.php', true);           // Loads from root (serverRoot=true)
Route::redirect('/login.php');                             // Tenant-aware redirect
```

**Layout pattern**: Most pages follow:
1. `require_once '../app.php'`
2. `Session::is_logged()`
3. HTML with `Route::includeFile()` for header/menu
4. `Route::includeFile('/includes/layouts/scripts.php', true)` at bottom

## PDF Generation

Custom `Classes\PDF` extends FPDF with school header/footer:
```php
$pdf = new PDF();
$pdf->AddPage();
$pdf->Cell(0, 5, 'Report Title', 0, 1, 'C');
$pdf->Output();
```

Header auto-includes school logo (if exists at `school_logo_path()`), name, address from `Admin::primaryAdmin()`. Set `$pdf->header = false` or `$pdf->logo = false` to disable.

## Development Workflow

**Dependencies**: `composer install` (PHP 8.2+), `npm install` (for SASS compilation)

**SASS compilation**: `npm run compile-sass` (defined in package.json)

**Database**: Multi-database setup. Legacy code uses constants (`__HOST`, `__DB_NAME`) from `demo/database.php`. Modern code uses Eloquent with connections defined in `config/database.php`

**Debugging**: LaraD umps available in dev (`ds($data)`). Legacy `dd($data)` helper also exists.

## Common Patterns

**Grade/course iteration**: Grades stored as strings (e.g., '01', '02', '11', '12'). Use `School->allGrades()` for dropdown lists

**Year handling**: Admin uses `year2`, others use `year` from school config. `Student` model auto-scopes by year

**School-specific behavior**: Check `__SCHOOL_ACRONYM` for conditional logic (e.g., 'cbtm' has different terminology)

**File organization**:
- `Classes/` - Legacy utilities, controllers (PSR-4 autoloaded)
- `app/Models/` - Eloquent models (PSR-4 autoloaded)  
- `Classes/Controllers/` - Legacy data access layer
- `demo/admin/`, `demo/regiweb/`, `demo/foro/` - User-facing modules by role

## Key Files to Reference

- `app/helpers.php` - Global helper functions
- `Classes/Route.php` - Routing/asset helpers
- `demo/app.php` - School bootstrap template
- `core/Database.php` - Multi-connection Eloquent setup
- `Classes/Session.php` - Auth validation logic
